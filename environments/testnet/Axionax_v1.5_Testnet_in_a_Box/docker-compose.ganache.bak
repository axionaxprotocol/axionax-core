services:
  hardhat:
    image: ghcr.io/foundry-rs/foundry:latest
    command: anvil --host 0.0.0.0 --port 8545 --chain-id 8615 --block-time 2
    ports: ["8545:8545"]
    restart: unless-stopped

  deployer:
    image: node:18-bullseye
    working_dir: /app
    environment:
      RPC_URL: http://hardhat:8545
    command: >
      bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi; node deploy.js || npm start"
    volumes:
      - ./deployer:/app
    depends_on: [ hardhat ]
    restart: on-failure

  faucet:
    image: node:18-bullseye
    working_dir: /app
    environment:
      RPC_URL: http://hardhat:8545
      FAUCET_PRIVATE_KEY: ${FAUCET_PRIVATE_KEY}
      CHAIN_ID: ${CHAIN_ID}
      PORT: "8081"
    command: >
      bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi;
      if npm run -q start 2>/dev/null; then :;
      else for f in server.js index.js app.js main.js; do [ -f \"$$f\" ] && exec node \"$$f\"; done;
      echo 'No start script or entry file found'; sleep 5; fi"
    ports: ["8081:8081"]
    volumes:
      - ./faucet:/app
    depends_on: [ hardhat ]
    restart: unless-stopped

  ui:
    image: nginx:alpine
    ports: ["8080:80"]
    volumes:
      - ./ui:/usr/share/nginx/html:ro
    depends_on: [ faucet ]
