services:
  hardhat:
    image: trufflesuite/ganache:v7.9.2
    command:
      - "--server.host=0.0.0.0"
      - "--server.port=8545"
      - "--chain.chainId=8615"
      - "--miner.blockTime=2"
      - "--wallet.mnemonic=test test test test test test test test test test test junk"
      - "--wallet.totalAccounts=10"
      - "--wallet.defaultBalance=10000"
    ports: ["8545:8545"]
    restart: unless-stopped

  faucet:
  image: node:18-bullseye
  working_dir: /app
  env_file:
    - .env              # << ผูก .env ทั้งไฟล์เข้า container
  environment:
    RPC_URL: http://hardhat:8545  # ค่านี้ fix ไว้ก็ได้
    # ที่เหลือ (CHAIN_ID, PORT, FAUCET_PRIVATE_KEY, ERC20_TOKEN_ADDRESS)
    # จะถูกโหลดอัตโนมัติจาก .env ผ่าน env_file
  command: >
    bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi;
    node index.js"
  ports: ["8081:8081"]
  volumes:
    - ./faucet:/app
  depends_on: [ hardhat ]
  restart: unless-stopped

  deployer:
    image: node:18-bullseye
    working_dir: /app
    environment:
      RPC_URL: http://hardhat:8545
      FAUCET_URL: http://faucet:8081
      DEPLOYER_PRIVATE_KEY: ${DEPLOYER_PRIVATE_KEY:-}
      FAUCET_PRIVATE_KEY: ${FAUCET_PRIVATE_KEY}
    command: >
      bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi; node deploy_token.js"
    volumes:
      - ./deployer:/app
    depends_on: [ hardhat ]
    restart: "no"

  ui:
    image: nginx:alpine
    ports: ["8080:80"]
    volumes:
      - ./ui:/usr/share/nginx/html:ro
    depends_on: [ faucet ]
    restart: unless-stopped
