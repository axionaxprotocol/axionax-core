services:
  hardhat:
    image: node:18-bullseye
    working_dir: /app
    command: >
      bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi; npm run start"
    ports: ["8545:8545"]
    volumes:
      - ./hardhat:/app
    restart: unless-stopped

  deployer:
    image: node:18-bullseye
    working_dir: /app
    environment:
      RPC_URL: http://hardhat:8545
    command: >
      bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi; npm start"
    volumes:
      - ./deployer:/app
    depends_on: [ hardhat ]
    restart: on-failure

  faucet:
    image: node:18-bullseye
    working_dir: /app
    environment:
      RPC_URL: http://hardhat:8545
      FAUCET_PRIVATE_KEY: ${FAUCET_PRIVATE_KEY}
      CHAIN_ID: ${CHAIN_ID}
    command: >
      bash -lc "if [ -f package-lock.json ]; then npm ci; else npm i; fi;
      if npm run -q start 2>/dev/null; then :;
      elif [ -f server.js ]; then node server.js;
      elif [ -f index.js ]; then node index.js;
      else node app.js; fi"
    ports: ["8081:8081"]
    volumes:
      - ./faucet:/app
    depends_on: [ hardhat ]
    restart: unless-stopped

  ui:
    image: nginx:alpine
    ports: ["8080:80"]
    # ถ้าไม่มีโฟลเดอร์ ui ให้ลบ volumes บรรทัดนี้ทิ้ง
    volumes:
      - ./ui:/usr/share/nginx/html:ro
    depends_on: [ faucet ]
